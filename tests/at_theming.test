<?php

class At_Theming_TestCase extends DrupalWebTestCase {
  public function getInfo() {
    return array(
      'name' => 'AT Theming',
      'description' => 'Make sure at_theming module is working correctly.',
      'group' => 'AT Theming',
    );
  }

  protected function setUp() {
    parent::setUp('atest_theming');
  }

  public function testViewRenderClass() {
    // Not sure why test modules are not enabled on setUp
    module_enable(array('atest_theming', 'at_theming'));

    $template_file = drupal_get_path('module', 'atest_theming') . '/templates/users.tpl.php';
    $view_name = 'atest_theming_user';
    $display_id = 'default';

    $output = at_id(new \Drupal\at_theming\ViewRender($template_file, $view_name, $display_id))->render();
    $this->assertTrue(preg_match('/UID: \d+/', $output));
    $this->verbose($output);
  }
}

class At_Theming_Twig_TestCase extends DrupalWebTestCase {
  public function getInfo() {
    return array(
      'name' => 'AT Theming: Twig',
      'description' => 'Make sure Twig features in at_theming module working correctly.',
      'group' => 'AT Theming',
    );
  }

  protected function setUp() {
    parent::setUp('atest_theming');
  }

  public function testTwigRender() {
    $template_file = drupal_get_path('module', 'atest_theming') . '/templates/hello.twig';
    $output = at_theming_render_template($template_file, array('name' => 'Andy Truong'));
    $this->assertTrue(strpos($output, 'Hello Andy Truong') !== FALSE);

    // with drupalView filter
    $template_file = '@atest_theming/twig/views/simple.html.twig';
    $output = at_theming_render_template($template_file);
    $this->assertTrue(strpos($output, '>1</a>') !== FALSE);

    // Create a box, demo content for drupalBlock filter
    $box['label'] = 'Demo drupalBox';
    $box['title'] = 'Demo drupalBox';
    $box['description'] = 'Box description';
    $box['type'] = 'atest_theming_block_type';
    $box['field_atest_theming_box_body']['und'][0]['value'] = 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla sodales, dui ac fermentum tincidunt, lorem nisl facilisis sem, ut consectetur urna velit vitae odio. Aliquam erat volutpat. Duis rutrum sollicitudin neque sed mattis. Proin risus elit, pretium eu tincidunt a, tempus quis tellus. Aliquam varius molestie varius. Aenean dictum metus quis orci faucibus ornare. Duis mattis pharetra tincidunt.';
    $box = entity_create('box', $box);
    $box->save();

    // with drupalBlock filter
    $template_file = '@atest_theming/twig/block.html.twig';
    $output = at_theming_render_template($template_file);
    $this->assertTrue(strpos($output, 'Powered by') !== FALSE);
    $this->assertTrue(strpos($output, 'id="Powered by') === FALSE);
    $this->assertTrue(strpos($output, 'id="block-boxes-demo-drupalbox') !== FALSE);
    $this->assertTrue(strpos($output, 'Lorem ipsum dolor sit amet') !== FALSE);
  }

  public function testTwigStringLoader() {
    $output = at_theming_render_string_template('Hello {{ name }}', array('name' => 'Andy Truong'));
    $this->assertEqual('Hello Andy Truong', $output);
  }

  public function testTwigFilters() {
    $output = at_theming_render_string_template("{{ 'user:1' | drupalEntity }}");
    $this->assertTrue(strpos($output, 'History'));
    $this->assertTrue(strpos($output, 'Member for'));
  }
}
